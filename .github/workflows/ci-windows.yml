name: Windows runner CI

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
  workflow_dispatch:
    inputs:
      release_channel:
        description: 'Override release channel (use nightly to force push)'
        required: false
        default: 'adhoc'
  workflow_call:
    inputs:
      release_channel:
        description: 'Channel identifier (nightly triggers push)'
        required: false
        default: 'adhoc'
        type: string

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  lint:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install hadolint
        run: |
          sudo wget -qO /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          sudo chmod +x /usr/local/bin/hadolint

      - name: Lint Windows Dockerfile
        run: |
          hadolint -c .hadolint.yaml windows/Dockerfile

  build-test-scan:
    runs-on: windows-2022
    needs: lint
    outputs:
      should_push: ${{ steps.meta.outputs.should_push }}
      date_tag: ${{ steps.meta.outputs.date_tag }}
    env:
      REGISTRY: ghcr.io
      IMAGE_REPOSITORY: ${{ github.repository_owner }}/runner-windows
      IMAGE_TAG: ghcr.io/${{ github.repository_owner }}/runner-windows:ci-${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate metadata
        id: meta
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $dateTag = (Get-Date -Format 'yyyyMMdd')
          "date_tag=$dateTag" >> $Env:GITHUB_OUTPUT
          $shouldPush = $false
          if ($Env:GITHUB_REF -eq 'refs/heads/main' -and $Env:GITHUB_EVENT_NAME -eq 'push') {
            $shouldPush = $true
          } elseif ($Env:GITHUB_EVENT_NAME -eq 'workflow_call' -and '${{ inputs.release_channel }}' -eq 'nightly') {
            $shouldPush = $true
          } elseif ($Env:GITHUB_EVENT_NAME -eq 'workflow_dispatch' -and '${{ github.event.inputs.release_channel }}' -eq 'nightly') {
            $shouldPush = $true
          }
          "should_push=$shouldPush" >> $Env:GITHUB_OUTPUT

      - name: Build runner image (windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          docker build --file windows/Dockerfile --tag $Env:IMAGE_TAG .

      - name: Run tool smoke tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          docker run --rm --entrypoint pwsh $Env:IMAGE_TAG -File C:\tests\Test-Tools.ps1

      - name: Run runner synth tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          docker run --rm --entrypoint pwsh $Env:IMAGE_TAG -File C:\tests\Test-Runner.ps1

      - name: Export image for approval gate
        if: steps.meta.outputs.should_push == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          docker save $Env:IMAGE_TAG --output runner-windows.tar

      - name: Upload image artifact
        if: steps.meta.outputs.should_push == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: runner-windows-tar
          path: runner-windows.tar
          retention-days: 1

  publish:
    needs: build-test-scan
    if: needs.build-test-scan.outputs.should_push == 'true'
    runs-on: windows-2022
    environment: windows-production
    env:
      REGISTRY: ghcr.io
      IMAGE_REPOSITORY: ${{ github.repository_owner }}/runner-windows
      BASE_IMAGE_TAG: ghcr.io/${{ github.repository_owner }}/runner-windows:ci-${{ github.sha }}
      DATE_TAG: ${{ needs.build-test-scan.outputs.date_tag }}
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: runner-windows-tar
          path: .

      - name: Load image
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          docker load --input runner-windows.tar

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push release tags
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          docker tag $Env:BASE_IMAGE_TAG "${Env:REGISTRY}/${Env:IMAGE_REPOSITORY}:latest"
          docker tag $Env:BASE_IMAGE_TAG "${Env:REGISTRY}/${Env:IMAGE_REPOSITORY}:${Env:DATE_TAG}"
          docker push "${Env:REGISTRY}/${Env:IMAGE_REPOSITORY}:latest"
          docker push "${Env:REGISTRY}/${Env:IMAGE_REPOSITORY}:${Env:DATE_TAG}"
